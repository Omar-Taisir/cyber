import React, { useState, useEffect, useRef } from 'react';
import { ScanResult, ScanLog, PentestWorkflow, ScanIntensity, PentestScope } from '../types';
import { analyzeSecurity } from '../services/geminiService';
import { TacticalDB } from '../services/dbService';

interface PentestModuleProps {
  onAudit: (event: string, details: string) => void;
  lang: 'en' | 'ar';
  syncedResults: ScanResult[];
  onSyncResult: (result: ScanResult) => Promise<void>;
}

const SCOPES: {id: PentestScope, label: string}[] = [
  { id: 'WEB_APP', label: 'Web Target' },
  { id: 'API_ENDPOINTS', label: 'API Interface' },
  { id: 'INFRASTRUCTURE', label: 'Internal Net' },
  { id: 'CLOUD_BUCKETS', label: 'Data Buckets' },
  { id: 'SUBDOMAINS', label: 'DNS Assets' }
];

const PentestModule: React.FC<PentestModuleProps> = ({ onAudit, lang, syncedResults, onSyncResult }) => {
  const [url, setUrl] = useState('');
  const [intensity, setIntensity] = useState<ScanIntensity>('QUICK');
  const [selectedScopes, setSelectedScopes] = useState<PentestScope[]>(['WEB_APP']);
  const [workflow, setWorkflow] = useState<PentestWorkflow>('THREAT_HUNTING');
  const [customHeaders, setCustomHeaders] = useState('');
  const [showAdvanced, setShowAdvanced] = useState(false);
  
  const [isScanning, setIsScanning] = useState(false);
  const [scanProgress, setScanProgress] = useState(0);
  const [localResults, setLocalResults] = useState<ScanResult[]>([]);
  const [sources, setSources] = useState<{title: string; uri: string}[]>([]);
  const [scanLogs, setScanLogs] = useState<ScanLog[]>([]);
  const [expandedIndex, setExpandedIndex] = useState<number | null>(null);
  const [currentStage, setCurrentStage] = useState<'IDLE' | 'RECON' | 'SOURCE_AUDIT' | 'FUZZING' | 'EXPLOITATION' | 'COMPLETE'>('IDLE');
  
  // Combine local and synced results for display
  const displayResults = [...localResults, ...syncedResults.filter(sr => !localResults.some(lr => lr.vulnerability === sr.vulnerability))];
  
  const consoleEndRef = useRef<HTMLDivElement>(null);

  const addScanLog = (msg: string, type: ScanLog['type'] = 'info') => {
    setScanLogs(prev => [...prev, { msg, type }]);
  };

  useEffect(() => {
    if (consoleEndRef.current) {
      consoleEndRef.current.scrollTop = consoleEndRef.current.scrollHeight;
    }
  }, [scanLogs]);

  const toggleScope = (scope: PentestScope) => {
    setSelectedScopes(prev => 
      prev.includes(scope) ? prev.filter(s => s !== scope) : [...prev, scope]
    );
  };

  const handleScan = async () => {
    if (!url) return;
    setIsScanning(true);
    setCurrentStage('RECON');
    setScanProgress(5);
    setScanLogs([]);
    setLocalResults([]);
    setSources([]);
    setExpandedIndex(null);
    onAudit("Pentest Engagement Started", `Target: ${url} | Methodology: ${workflow}`);

    try {
      addScanLog(`CONNECTING TO VORTEX_CYAN_MESH...`, 'info');
      addScanLog(`INITIATING TARGET RECONNAISSANCE [GROUNDING_ACTIVE]`, 'ai');
      
      const phases = [
        { msg: "Fingerprinting HTTP security headers and server version...", p: 25, stage: 'RECON' },
        { msg: "Analyzing static assets for sensitive logical identifiers...", p: 45, stage: 'SOURCE_AUDIT' },
        { msg: "Fuzzing target entry points with pre-compiled offensive templates...", p: 65, stage: 'FUZZING' },
        { msg: "Validating logical breach vectors via Gemini-3-Pro...", p: 85, stage: 'EXPLOITATION' }
      ];

      for (const phase of phases) {
        setCurrentStage(phase.stage as any);
        addScanLog(phase.msg, 'info');
        setScanProgress(phase.p);
        await new Promise(r => setTimeout(r, 800));
      }

      const response = await analyzeSecurity(
        url, 
        customHeaders, 
        workflow, 
        intensity,
        selectedScopes
      );
      
      setLocalResults(response.results);
      setSources(response.sources);
      
      if (response.results.length > 0) {
        for (const res of response.results) {
          await onSyncResult(res);
        }
      }

      setScanProgress(100);
      setCurrentStage('COMPLETE');
      addScanLog(`AUDIT COMPLETE. ${response.results.length} VULNERABILITIES IDENTIFIED.`, response.results.length > 0 ? 'warn' : 'success');
    } catch (err: any) {
      addScanLog(`CRITICAL ERROR: ${String(err.message)}`, 'error');
      setCurrentStage('IDLE');
    } finally {
      setIsScanning(false);
    }
  };

  const t = {
    en: {
      TITLE: 'Tactical_Audit',
      SUB: 'Aegis Offensive Engagement',
      ENGAGEMENT: 'Engagement Controls',
      MONITOR: 'Telemetric Stream',
      RESULTS: 'Vulnerability Manifest',
      METHOD: 'Audit Logic',
      TARGET: 'Target Node Address',
      START: 'START_ENGAGEMENT',
      STOP: 'ABORT_AUDIT',
      ADVANCED: 'Technical Configuration',
      SOURCES: 'Verification Sources',
      // Added missing key to fix property access error on line 273
      LISTENING: 'Awaiting telemetry uplink...'
    },
    ar: {
      TITLE: 'التدقيق_التكتيكي',
      SUB: 'إيجيس للمشاركة الهجومية',
      ENGAGEMENT: 'ضوابط المشاركة',
      MONITOR: 'بث القياس عن بعد',
      RESULTS: 'بيان نقاط الضعف',
      METHOD: 'منطق التدقيق',
      TARGET: 'عنوان عقدة الهدف',
      START: 'بدء_المشاركة',
      STOP: 'إلغاء_التدقيق',
      ADVANCED: 'الإعدادات الفنية',
      SOURCES: 'مصادر التحقق',
      // Added missing key to fix property access error on line 273
      LISTENING: 'في انتظار ربط القياس عن بعد...'
    }
  }[lang];

  return (
    <div className={`space-y-10 pb-40 animate-in fade-in duration-700 ${lang === 'ar' ? 'font-arabic' : ''}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
      <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 md:gap-10 border-b border-white/5 pb-10">
        <div className="space-y-2 w-full md:w-auto">
          <div className="flex items-center gap-4">
             <span className="bg-cyan-400 text-black px-3 py-1 text-[10px] font-black tracking-widest uppercase rounded shadow-[0_0_15px_rgba(0,242,255,0.3)]">AUDIT_v4.2</span>
             <span className="text-cyan-400 text-[10px] font-black uppercase tracking-[0.4em] opacity-60">{t.SUB}</span>
          </div>
          <h1 className="text-3xl sm:text-4xl md:text-5xl font-black text-white tracking-tighter uppercase italic break-words">{t.TITLE}<span className="text-cyan-400">_</span></h1>
        </div>
      </header>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div className="lg:col-span-4 space-y-8">
          <div className="glass-panel p-8 space-y-10 bg-white/[0.01]">
            <h3 className="text-[11px] font-black text-white uppercase tracking-[0.4em] flex items-center gap-4 border-b border-white/5 pb-6">
               <i className="fas fa-crosshairs text-cyan-400"></i> {t.ENGAGEMENT}
            </h3>

            <div className="space-y-6">
              <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block ml-2">{t.TARGET}</label>
              <input 
                type="text"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                placeholder="https://vulnerable.target"
                className="w-full bg-black border border-white/10 rounded-2xl px-6 py-5 text-sm font-mono text-cyan-400 focus:border-cyan-400/50 outline-none transition-all"
              />
            </div>

            <div className="space-y-4">
              <button 
                onClick={() => setShowAdvanced(!showAdvanced)}
                className="text-[9px] font-black text-cyan-400/60 uppercase tracking-widest flex items-center gap-3 hover:text-cyan-400 transition-all"
              >
                <i className={`fas fa-chevron-${showAdvanced ? 'up' : 'down'}`}></i> {t.ADVANCED}
              </button>
              {showAdvanced && (
                <textarea
                  value={customHeaders}
                  onChange={(e) => setCustomHeaders(e.target.value)}
                  placeholder="X-Custom-Header: value&#10;Cookie: session=xyz"
                  className="w-full h-32 bg-black/60 border border-white/10 rounded-xl p-4 text-[11px] font-mono text-slate-400 focus:border-cyan-400/30 outline-none transition-all resize-none"
                />
              )}
            </div>

            <div className="space-y-6">
              <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block ml-2">{t.METHOD}</label>
              <div className="grid grid-cols-1 gap-3">
                {[
                  { id: 'QUICK', label: 'Passive Discovery', icon: 'fa-radar' },
                  { id: 'DEEP', label: 'Full Breach Analysis', icon: 'fa-skull' }
                ].map(opt => (
                  <button
                    key={opt.id}
                    onClick={() => setIntensity(opt.id as ScanIntensity)}
                    className={`p-5 rounded-2xl border text-left transition-all flex items-center gap-5 ${
                      intensity === opt.id 
                        ? 'bg-cyan-400 border-cyan-400 text-black shadow-xl shadow-cyan-400/20' 
                        : 'bg-black/60 border-white/5 text-slate-600 hover:text-white hover:border-white/20'
                    }`}
                  >
                    <i className={`fas ${opt.icon} text-base`}></i>
                    <span className="text-[11px] font-black uppercase tracking-widest">{opt.label}</span>
                  </button>
                ))}
              </div>
            </div>

            <button
              onClick={handleScan}
              disabled={isScanning || !url}
              className={`w-full py-6 font-black text-[12px] uppercase tracking-[0.5em] rounded-2xl transition-all flex items-center justify-center gap-4 active:scale-95 ${
                isScanning ? 'bg-red-500/10 text-red-500 border border-red-500/20' : 'btn-action'
              }`}
            >
              {isScanning ? <><i className="fas fa-stop-circle animate-pulse"></i> {t.STOP}</> : <><i className="fas fa-bolt"></i> {t.START}</>}
            </button>
          </div>

          <div className="glass-panel p-8 space-y-6">
            <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-widest block border-b border-white/5 pb-4">Audit Pipeline</h3>
            <div className="space-y-6">
              {[
                { id: 'RECON', label: 'Passive Recon', icon: 'fa-search' },
                { id: 'SOURCE_AUDIT', label: 'Source Review', icon: 'fa-code' },
                { id: 'FUZZING', label: 'Payload Fuzzing', icon: 'fa-vial' },
                { id: 'EXPLOITATION', label: 'Logical Breach', icon: 'fa-biohazard' }
              ].map((step) => (
                <div key={step.id} className="flex items-center gap-6">
                  <div className={`w-10 h-10 rounded-xl border flex items-center justify-center text-xs transition-all ${
                    currentStage === step.id ? 'bg-cyan-400 border-cyan-400 text-black shadow-[0_0_15px_rgba(0,242,255,0.4)]' : 
                    isScanning && displayResults.length > 0 ? 'bg-white/5 border-white/10 text-slate-600' : 'bg-black/40 border-white/5 text-slate-800'
                  }`}>
                    <i className={`fas ${step.icon}`}></i>
                  </div>
                  <div className="flex-1">
                    <p className={`text-[10px] font-black uppercase tracking-widest ${currentStage === step.id ? 'text-white' : 'text-slate-800'}`}>{step.label}</p>
                    <div className="h-[2px] w-full bg-white/5 mt-2 rounded-full overflow-hidden">
                       <div className={`h-full bg-cyan-400 transition-all duration-1000 ${currentStage === step.id ? 'w-full' : 'w-0'}`}></div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div className="lg:col-span-8 space-y-8">
          <div className="glass-panel p-8 flex flex-col h-[450px]">
             <div className="flex items-center justify-between mb-8 pb-4 border-b border-white/5">
                <h3 className="text-[11px] font-black text-white uppercase tracking-[0.4em] flex items-center gap-4">
                   <i className="fas fa-satellite-dish text-cyan-400"></i> {t.MONITOR}
                </h3>
                {isScanning && (
                   <div className="flex items-center gap-4">
                      <div className="h-1 w-32 bg-white/5 rounded-full overflow-hidden">
                         <div className="h-full bg-cyan-400 transition-all duration-500" style={{ width: `${scanProgress}%` }}></div>
                      </div>
                      <span className="text-[10px] font-black text-cyan-400 mono animate-pulse">{scanProgress}%</span>
                   </div>
                )}
             </div>
             
             <div ref={consoleEndRef} className="flex-1 bg-black/60 rounded-2xl p-8 font-mono text-[11px] space-y-3 overflow-y-auto custom-scrollbar border border-white/5 shadow-inner">
                {scanLogs.length === 0 ? (
                  <div className="h-full flex flex-col items-center justify-center opacity-10 grayscale text-center">
                    <i className="fas fa-tower-broadcast text-6xl mb-8"></i>
                    <p className="font-black uppercase tracking-[0.6em]">{t.LISTENING}</p>
                  </div>
                ) : (
                  scanLogs.map((log, i) => (
                    <div key={i} className={`flex gap-6 border-l-2 pl-6 py-2 transition-all ${
                      log.type === 'error' ? 'text-red-500 border-red-500' : 
                      log.type === 'success' ? 'text-cyan-400 border-cyan-400' : 
                      log.type === 'ai' ? 'text-cyan-400 italic border-cyan-400/40' : 'text-slate-500 border-white/10'
                    }`}>
                      <span className="opacity-40">[{new Date().toLocaleTimeString()}]</span>
                      <span className="flex-1 leading-relaxed">{log.msg}</span>
                    </div>
                  ))
                )}
             </div>
          </div>

          <div className="space-y-6">
             {sources.length > 0 && (
               <div className="glass-panel p-8 border-cyan-400/20 bg-cyan-400/[0.03]">
                 <h4 className="text-[10px] font-black text-cyan-400 uppercase tracking-widest mb-6 flex items-center gap-3">
                   <i className="fas fa-search-nodes"></i> {t.SOURCES}
                 </h4>
                 <div className="flex flex-wrap gap-3">
                   {sources.map((s, idx) => (
                     <a key={idx} href={s.uri} target="_blank" rel="noopener noreferrer" className="px-5 py-2.5 bg-black/60 border border-white/5 rounded-xl text-[10px] text-slate-500 hover:text-cyan-400 hover:border-cyan-400/40 transition-all flex items-center gap-3">
                       <i className="fas fa-link text-[8px] opacity-40"></i> {s.title}
                     </a>
                   ))}
                 </div>
               </div>
             )}

             {displayResults.length > 0 ? displayResults.map((res, i) => (
                <div key={i} className="glass-panel border-white/5 hover:border-cyan-400/40 transition-all bg-white/[0.01] overflow-hidden">
                  <div 
                    className={`p-8 flex items-center justify-between cursor-pointer ${expandedIndex === i ? 'bg-cyan-400/[0.03]' : ''}`}
                    onClick={() => setExpandedIndex(expandedIndex === i ? null : i)}
                  >
                    <div className="flex items-center gap-8">
                      <div className={`w-2 h-12 rounded-full ${
                        res.severity === 'Critical' ? 'bg-red-500' : 
                        res.severity === 'High' ? 'bg-orange-500' : 'bg-cyan-400'
                      }`}></div>
                      <div>
                        <div className="flex items-center gap-4 mb-2">
                          <span className={`text-[10px] font-black uppercase tracking-widest ${
                            res.severity === 'Critical' ? 'text-red-500' : 
                            res.severity === 'High' ? 'text-orange-500' : 'text-cyan-400'
                          }`}>{res.severity}</span>
                          <span className="text-slate-700 text-[10px] font-black uppercase tracking-[0.2em]">{res.cveId || 'X-VECTOR'}</span>
                        </div>
                        <h4 className="text-xl font-black text-white uppercase italic tracking-tighter">{res.vulnerability}</h4>
                      </div>
                    </div>
                    <i className={`fas fa-chevron-${expandedIndex === i ? 'up' : 'down'} text-slate-700`}></i>
                  </div>
                  
                  {expandedIndex === i && (
                    <div className="p-10 border-t border-white/5 bg-black/40 animate-in slide-in-from-top-4 space-y-10">
                       <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                          <div className="space-y-4">
                             <p className="text-[10px] font-black text-cyan-400 uppercase tracking-widest opacity-60">Breach_Mechanism</p>
                             <p className="text-[13px] text-slate-300 leading-relaxed font-medium">{res.description}</p>
                          </div>
                          <div className="space-y-4">
                             <p className="text-[10px] font-black text-cyan-400 uppercase tracking-widest opacity-60">Operational_Impact</p>
                             <p className="text-[13px] text-slate-300 leading-relaxed font-medium">{res.impact}</p>
                          </div>
                       </div>
                       
                       <div className="space-y-4">
                          <p className="text-[10px] font-black text-cyan-400 uppercase tracking-widest opacity-60">Validation_PoC</p>
                          <div className="bg-black/80 border border-white/10 rounded-2xl p-8 font-mono text-[12px] text-white/80 overflow-x-auto relative group">
                             <code>{res.exploitPoC}</code>
                             <button 
                                onClick={(e) => { e.stopPropagation(); navigator.clipboard.writeText(res.exploitPoC || ''); }}
                                className="absolute top-6 right-6 w-10 h-10 rounded-xl bg-white/5 hover:bg-cyan-400 hover:text-black transition-all flex items-center justify-center opacity-0 group-hover:opacity-100"
                             >
                                <i className="fas fa-copy"></i>
                             </button>
                          </div>
                       </div>
                    </div>
                  )}
                </div>
             )) : !isScanning && (
                <div className="py-24 text-center opacity-5 grayscale flex flex-col items-center gap-6">
                   <i className="fas fa-microscope text-7xl"></i>
                   <p className="text-[11px] font-black uppercase tracking-[0.6em]">{lang === 'ar' ? 'لا توجد مشاركات نشطة' : 'NO_ACTIVE_ENGAGEMENTS'}</p>
                </div>
             )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default PentestModule;